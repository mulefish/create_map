<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <script src="https://d3js.org/d3.v4.js"></script>
  <style>
    body {margin: 0 }
    svg { background-color: #ffffff; }
    svg circle.old { fill: green; }
    svg circle.new { fill: blue;  }
    svg {
    border-style: solid;
    border-width: 1px;
    }
  </style>
</head>

<body>
    <div id="svgdiv"></div>


  <script>
    // Fake react!
    const width = window.innerWidth
    const height = 550 // window.innerWidth
    const dom = `<svg width='${width}' height='${height}' id='grid'></svg>`
    document.getElementById('svgdiv').innerHTML = dom
</script>

  <script>
    let lineGenerator = d3.line()
    let svg = d3.select('svg')
    let container = svg.append('g')
    let data = []
      container.append("image")
        .attr("width",  ( 1.5 * width ) + "px")
        .attr("xlink:href", "colonial_conquest_map.png")
    let zoomTrans = {x:0, y:0, scale:1}



    function drawLine() {

        if ( data.length > 1 ) { 
                const i2 = data.length - 1
                const i1 = data.length - 2 
                const p1 = data[i1]
                const p2 = data[i2]

                container.append("line")          // attach a line
                .style("stroke", "black")  // colour the line
                .attr("x1", p1.x)     // x position of the first end of the line
                .attr("y1", p1.y)      // y position of the first end of the line
                .attr("x2", p2.x)     // x position of the second end of the line
                .attr("y2", p2.y) // y position of the second;    // y position of the second end of the line

            }

    }
    function init() {
      let zoom = d3.zoom()
        .scaleExtent([0.25, 2.25])
        .on("zoom", () => {
          zoomTrans.x = d3.event.transform.x;
          zoomTrans.y = d3.event.transform.y;
          zoomTrans.scale = d3.event.transform.k;
          container.attr("transform", d3.event.transform);
        });

      svg.call(zoom)
        .on("dblclick.zoom", null)

      svg.on('click', d => {
        let x = (d3.event.x - zoomTrans.x)/zoomTrans.scale;
        let y = (d3.event.y - zoomTrans.y)/zoomTrans.scale;
        data.push({ x, y, id: Math.random() });
        drawLine()
        redraw();
      });




    }

    function redraw() {


/*
if ( data.length > 1 ) {

    for ( let i = 1; i < data.length; i++) {

                const p1 = data[i - 1]
                const p2 = data[i]


    container.append("line")          // attach a line
                .style("stroke", "black")  // colour the line
                .attr("x1", p1.x)     // x position of the first end of the line
                .attr("y1", p1.y)      // y position of the first end of the line
                .attr("x2", p2.x)     // x position of the second end of the line
                .attr("y2", p2.y) // y position of the second;    // y position of the second end of the line
    } 

}
*/

console.log("")
      let grp = container.selectAll('circle')
        .data(data, (d) => {
            return d.id
        })
        .attr('class', 'old')

      grp.exit().remove();
      
      let grpEnter = grp.enter()


      let group = grpEnter
      group.append('circle')
        .attr('class', 'new')
        .attr('r', 15)
        .attr('cx', d => d.x)
        .attr('cy', d => d.y)
        .attr('fill', '#000000')
        .attr('fill-opacity', 0.0)
        .attr('stroke', '#000000')
        .attr('stroke-opacity', 0.5)
      grp = grpEnter.merge(grp);
    }
    init();
    redraw();
  </script>

</body>

</html>